<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mental Gym – N‑Back</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0B1010; --panel:#0f1414; --panel-border:#13c1b1;
      --text:#f9fafb; --muted:#9fb3b0; --accent:#13c1b1; --accent-2:#0ea295; --ok:#2dd4bf; --danger:#ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Inter,-apple-system,BlinkMacSystemFont;}
    .screenwrap{min-height:100%;display:grid;place-items:center;padding:clamp(12px,4vw,24px);}
    .card{width:min(640px,100%);background:linear-gradient(180deg,var(--panel),#0b1111);
      border:1px solid var(--panel-border);border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.02);padding:20px;}
    h1{margin:0 0 6px 0;font-size:22px;letter-spacing:.2px}
    p{margin:0 0 12px 0;color:var(--muted);font-size:14px;line-height:1.4}
    .stats{display:flex;gap:12px;margin-top:8px;color:var(--muted);flex-wrap:wrap;font-size:14px}
    .display{width:100%;margin:14px 0;padding:20px 16px;text-align:center;
      font-size:clamp(36px,10vw,48px);letter-spacing:.1em;background:#0a1111;border:2px dashed #1b2a2b;border-radius:14px;user-select:none;box-sizing:border-box;}
    .row{width:100%;display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
    .btn{flex:1;text-align:center;appearance:none;cursor:pointer;padding:8px 12px;border-radius:10px;border:1px solid transparent;background:#0c1414;color:var(--text);transition:transform .06s ease,border-color .15s ease,background .15s ease;font-size:14px;}
    .btn:hover{border-color:#223b3b}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);color:#0B1010;font-weight:600;}
    .btn.primary:hover{background:var(--accent-2);}
    .btn.ghost{border:1px solid #1b2b2b;opacity:.92;}
    .good{color:var(--ok)}
    .bad{color:var(--danger)}
  </style>
</head>
<body>
  <div class="screenwrap">
    <div class="card">
      <h1>2‑Back Memory</h1>
      <p>Watch the stream of letters. Tap when the current letter matches the one two steps back. Score = correct hits minus false alarms.</p>
      <div class="stats">
        <div>Time: <span id="timeLeft">60</span>s</div>
        <div>Score: <span id="score">0</span></div>
        <div>Your best: <span id="best">–</span></div>
      </div>
      <div id="display" class="display">Press Start</div>
      <div class="row" style="margin-top:6px">
        <button id="start" class="btn primary">Start</button>
        <button id="matchBtn" class="btn" style="display:none">Match!</button>
        <button id="retry" class="btn" style="display:none">Try again</button>
        <button id="leaderboardBtn" class="btn ghost" style="display:none">Leaderboard</button>
      </div>
    </div>
  </div>
<script>
(function(){
  const GAME_ID = "strength:n-back";
  const API_BASE = "/.netlify/functions";
  function getQueryParam(name){const u=new URL(window.location.href);return u.searchParams.get(name)||"";}
  async function startSession(email){const r=await fetch(`${API_BASE}/session-start`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});if(!r.ok) throw new Error('session failed');const{token}=await r.json();localStorage.setItem('mg_token',token);return token;}
  async function loadScore(token,game_id){const r=await fetch(`${API_BASE}/score?game_id=${encodeURIComponent(game_id)}`,{headers:{Authorization:`Bearer ${token}`}});if(!r.ok) return null;return await r.json();}
  async function saveScore(token,game_id,best,streak){await fetch(`${API_BASE}/score`,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${token}`},body:JSON.stringify({game_id,best,streak})});}
  const display=document.getElementById('display');
  const startBtn=document.getElementById('start');
  const matchBtn=document.getElementById('matchBtn');
  const retryBtn=document.getElementById('retry');
  const leaderboardBtn=document.getElementById('leaderboardBtn');
  const timeEl=document.getElementById('timeLeft');
  const scoreEl=document.getElementById('score');
  const bestEl=document.getElementById('best');
  let best=Number(localStorage.getItem('mg_strength_nback_best'))||0;
  if(best>0) bestEl.textContent=best;
  // auto session load
  (async()=>{
    try{
      const urlEmail=getQueryParam('email');if(urlEmail){await startSession(urlEmail.trim().toLowerCase());}
      const token=localStorage.getItem('mg_token');if(token){const cloud=await loadScore(token,GAME_ID);if(cloud){const cloudBest=Number(cloud.best)||0;if(cloudBest>0&&cloudBest>best){best=cloudBest;bestEl.textContent=best;}}}
    }catch(_){}
  })();
  let intervalId=null;let timeLeft=60;let score=0;const history=[];let awaiting=false;
  function reset(){clearInterval(intervalId);intervalId=null;timeLeft=60;score=0;history.length=0;timeEl.textContent='60';scoreEl.textContent='0';display.textContent='Press Start';display.className='display';startBtn.style.display='inline-block';matchBtn.style.display='none';retryBtn.style.display='none';leaderboardBtn.style.display='none';}
  function begin(){reset();startBtn.style.display='none';matchBtn.style.display='inline-block';score=0;history.length=0;timeLeft=60;timeEl.textContent='60';scoreEl.textContent='0';
    nextStimulus();intervalId=setInterval(()=>{timeLeft--;timeEl.textContent=String(timeLeft);if(timeLeft<=0){finish();}},1000);
  }
  function nextStimulus(){if(timeLeft<=0){return;}const letters=['A','B','C','D','E','F'];const letter=letters[Math.floor(Math.random()*letters.length)];history.push(letter);display.textContent=letter;display.className='display';awaiting=true;
    // schedule next after 1.6s
    setTimeout(()=>{if(awaiting){ // user failed to respond (missed hit)
        // nothing (no penalty for miss). simply move on
      }
      awaiting=false;nextStimulus();
    },1600);
  }
  function handleMatch(){if(!awaiting)return;awaiting=false;const len=history.length;const match=(len>=3 && history[len-1]===history[len-3]);
    if(match){score++;display.className='display good';display.textContent='✔';}else{score--;display.className='display bad';display.textContent='✖';}
    scoreEl.textContent=String(score);
  }
  function finish(){clearInterval(intervalId);intervalId=null;matchBtn.style.display='none';retryBtn.style.display='inline-block';leaderboardBtn.style.display='inline-block';display.className='display accent';display.textContent='Done! Score: '+score; // update best if higher
    if(score>best){best=score;localStorage.setItem('mg_strength_nback_best',String(best));bestEl.textContent=best;const token=localStorage.getItem('mg_token');if(token){saveScore(token,GAME_ID,best,0).catch(()=>{});} }
    // post session result
    try{const email=getQueryParam('email')||'anonymous@example.com';postScore(email,GAME_ID,score,0);}catch(_){}
  }
  function postScore(email,game_id,best,streak){fetch('/.netlify/functions/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,game_id,best,streak})}).catch(()=>{});}
  startBtn.addEventListener('click',begin);
  retryBtn.addEventListener('click',begin);
  matchBtn.addEventListener('click',handleMatch);
  document.addEventListener('keydown',e=>{if(e.code==='Space'){handleMatch();}});
  // Navigate to the dedicated leaderboard page for this module
  leaderboardBtn.addEventListener('click',()=>{
    window.location.href='/strength/n-back/leaderboard/';
  });
})();
</script>
</body>
</html>